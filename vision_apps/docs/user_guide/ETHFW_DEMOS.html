<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>Vision Apps User Guide: ETHFW Demos</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Vision Apps User Guide
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ETHFW_DEMOS.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ETHFW Demos </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Ethernet Firmware is integrated part of vision_apps and enabled by default. This stack is TI RTOS based application for configuration of Ethernet switch and is expected to be hosted on Cortex R5F in Main Domain.</p>
<div class="image">
<img src="ethfw_demo_setup.png" alt="ethfw_demo_setup.png"/>
</div>
<p>The switch software uses PDK Enet and other drivers for respective IP configuration. The software stack contains remote configuration server, resource management library, switch resident protocols, proxy layers to handle local and remote API calls and demonstration applications (EthFw Demos).</p>
<p>Below are some top-level features demonstarted in EthFw:</p><ul>
<li>Basic L2 switching</li>
<li>Send/receive packets over TCP/UDP</li>
<li>TCP iperf performance testing</li>
<li>Support for remote cores (Linux, QNX)</li>
<li>Time-synchronisation using gPTP</li>
</ul>
<h1><a class="anchor" id="autotoc_md188"></a>
Hardware Setup</h1>
<p>The below are required to run EthFw</p><ul>
<li>J7ES/J7AHP EVM</li>
<li>GESI daughter card (needed for J7ES)</li>
<li>QPENET (i.e. QSGMII) daughter card (needed for J7ES/J7AHP)</li>
<li>Two PCs running Ubuntu connected to the GESI board (for J7ES) in order to demonstrate the L2 switching capabilities as well as to generate and monitor Ethernet traffic</li>
<li>A pair of network cables, connected as shown in the setup diagram above (for J7ES)<ul>
<li>One cable connected to port8 (switch port) on the GESI card and other end connected to Linux machine (i.e. the DHCP server)</li>
<li>Second cable connected to port3 (switch port) on the GESI card and other end connected to client machine</li>
</ul>
</li>
<li>UART cable connected to main UART port on the J7ES EVM</li>
<li>12V power supply for the EVM</li>
<li>SD card</li>
</ul>
<h1><a class="anchor" id="autotoc_md189"></a>
Software Setup</h1>
<ul>
<li>Install and run a DHCP server on PC1 Ubuntu 22.04 machine by following the instructions here <a href="https://help.ubuntu.com/community/isc-dhcp-server">https://help.ubuntu.com/community/isc-dhcp-server</a> This machine will provide IP to R5F (Main MCU2_0), A72 and any client connected via switch port of GESI/QSGMII card.</li>
<li>iperf network performance tool is required on either PC1 or PC2. Install iperf in the selected Ubuntu PC(s): <div class="fragment"><div class="line">sudo apt-get install iperf</div></div><!-- fragment --></li>
<li>packETH tool is required only in PC1. Install packETH generator tool on Linux PC. The Ubuntu installation can be found in their website: <a href="https://packeth.sourceforge.net/packeth/Installation.html">https://packeth.sourceforge.net/packeth/Installation.html</a> The packEth configurations used in this demo are included in the Ethernet Firmware package at &lt;ETHFW_PATH&gt;/docs/packeth_configurations/ <blockquote class="doxtable">
<p><b>Note:</b> Please check licensing information and terms of usage of packETH tool and make sure it adheres to your organization's policy before using and configuring it. </p>
</blockquote>
</li>
<li>Wireshark packet analyser tool is required in both PC1 and PC2. Refer to the Wireshark installation instructions on Ubuntu in this website: <a href="https://linuxhint.com/install_wireshark_ubuntu/">https://linuxhint.com/install_wireshark_ubuntu/</a></li>
<li>For testing gPTP time synchronisation we need to install ptp4l tool on PC2 which is connected to MAC port by following the instructions here <a href="https://tsn.readthedocs.io/timesync.html,">https://tsn.readthedocs.io/timesync.html,</a> we can configure PC2 to run either as master or slave by editing the config file. <blockquote class="doxtable">
<p><b>Note:</b> From 9.1 SDK any MAC port from <code>gEthAppSwitchPorts</code> supports gPTP, please connect to these MAC ports to avoid missing timestamps warnings. </p>
</blockquote>
</li>
</ul>
<div class="fragment"><div class="line">static Enet_MacPort gEthAppSwitchPorts[]=</div><div class="line">{</div><div class="line"> #if defined(SOC_J721E)</div><div class="line">    ENET_MAC_PORT_3,</div><div class="line">    ENET_MAC_PORT_8,</div><div class="line"> #if defined(ENABLE_QSGMII_PORTS)</div><div class="line">    ENET_MAC_PORT_2,</div><div class="line">    ENET_MAC_PORT_5,</div><div class="line"> #endif</div><div class="line"> #endif</div><div class="line"></div><div class="line"> #if defined(SOC_J784S4)</div><div class="line">    ENET_MAC_PORT_3,</div><div class="line">    ENET_MAC_PORT_5,</div><div class="line"> #endif</div><div class="line">};</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md190"></a>
Running the demo (Linux + RTOS) or (QNX + RTOS)</h1>
<ul>
<li>Build the application and related libraries as mentioned in <a class="el" href="BUILD_INSTRUCTIONS.html">Build Instructions</a></li>
<li>After flashing binaries on SD card using <code>make linux_fs_install_sd</code> insert in the SD card slot in the EVM</li>
<li>Open UART client like minicom on /dev/ttyUSB0 (instance 0) where Linux logs usually appear.</li>
<li>Power on the EVM and let the OS come up.</li>
<li>Login with root and navigate to /opt/vision_apps on linux and /ti_fs/vision_apps on QNX, run the ./vision_apps_init.sh script.</li>
<li>Upon sucessfull completion you should see EthFw initialization logs, gPTP initialization logs and version as given below.</li>
</ul>
<div class="fragment"><div class="line">j7-evm login: root</div><div class="line">Last login: Mon Nov 29 14:43:33 UTC 2021</div><div class="line">root@j7-evm:~# source /opt/vision_apps/vision_apps_init.sh</div><div class="line">...</div><div class="line">...</div><div class="line">[MCU2_0]     17.235797 s: ETHFW: Init ... !!!</div><div class="line">[MCU2_0]     13.992135 s: Warning: Using 6 MAC address(es) from static pool</div><div class="line">[MCU2_0]     13.992450 s: ETHFW: Shared multicasts (software fanout):</div><div class="line">[MCU2_0]     13.992492 s:   01:00:5e:00:00:01</div><div class="line">[MCU2_0]     13.992538 s:   01:00:5e:00:00:fb</div><div class="line">[MCU2_0]     13.992570 s:   01:00:5e:00:00:fc</div><div class="line">[MCU2_0]     13.992597 s:   33:33:00:00:00:01</div><div class="line">[MCU2_0]     13.992620 s:   33:33:ff:1d:92:c2</div><div class="line">[MCU2_0]     13.992643 s:   01:80:c2:00:00:00</div><div class="line">[MCU2_0]     13.992667 s:   01:80:c2:00:00:03</div><div class="line">[MCU2_0]     13.992691 s: ETHFW: Reserved multicasts:</div><div class="line">[MCU2_0]     13.992714 s:   01:80:c2:00:00:0e</div><div class="line">[MCU2_0]     13.992737 s:   01:1b:19:00:00:00</div><div class="line">[MCU2_0]     13.992951 s: EnetMcm: CPSW_9G on MAIN NAVSS</div><div class="line">[MCU2_0]     14.000069 s: Mdio_open: MDIO manual mode enabled</div><div class="line">[MCU2_0]     14.002454 s: PHY 0 is alive</div><div class="line">[MCU2_0]     14.002749 s: PHY 3 is alive</div><div class="line">[MCU2_0]     14.003372 s: PHY 12 is alive</div><div class="line">[MCU2_0]     14.003615 s: PHY 15 is alive</div><div class="line">[MCU2_0]     14.003714 s: PHY 16 is alive</div><div class="line">[MCU2_0]     14.003813 s: PHY 17 is alive</div><div class="line">[MCU2_0]     14.003911 s: PHY 18 is alive</div><div class="line">[MCU2_0]     14.004006 s: PHY 19 is alive</div><div class="line">[MCU2_0]     14.004295 s: PHY 23 is alive</div><div class="line">[MCU2_0]     14.005237 s: EnetPhy_bindDriver: PHY 12: OUI:080028 Model:23 Ver:01 &lt;-&gt; &#39;dp83867&#39; : OK</div><div class="line">[MCU2_0]     14.005741 s: EnetPhy_bindDriver: PHY 0: OUI:080028 Model:23 Ver:01 &lt;-&gt; &#39;dp83867&#39; : OK</div><div class="line">[MCU2_0]     14.006221 s: EnetPhy_bindDriver: PHY 3: OUI:080028 Model:23 Ver:01 &lt;-&gt; &#39;dp83867&#39; : OK</div><div class="line">[MCU2_0]     14.006714 s: EnetPhy_bindDriver: PHY 15: OUI:080028 Model:23 Ver:01 &lt;-&gt; &#39;dp83867&#39; : OK</div><div class="line">[MCU2_0]     14.007208 s: EnetPhy_bindDriver: PHY 16: OUI:0001c1 Model:27 Ver:00 &lt;-&gt; &#39;vsc8514&#39; : OK</div><div class="line">[MCU2_0]     14.007710 s: EnetPhy_bindDriver: PHY 17: OUI:0001c1 Model:27 Ver:00 &lt;-&gt; &#39;vsc8514&#39; : OK</div><div class="line">[MCU2_0]     14.008201 s: EnetPhy_bindDriver: PHY 18: OUI:0001c1 Model:27 Ver:00 &lt;-&gt; &#39;vsc8514&#39; : OK</div><div class="line">[MCU2_0]     14.008708 s: EnetPhy_bindDriver: PHY 19: OUI:0001c1 Model:27 Ver:00 &lt;-&gt; &#39;vsc8514&#39; : OK</div><div class="line">[MCU2_0]     14.010550 s: </div><div class="line">[MCU2_0] ETHFW Version   : 0.04.00</div><div class="line">[MCU2_0]     17.138849 s: ETHFW Build Date: Mar 25, 2024</div><div class="line">[MCU2_0]     17.138868 s: ETHFW Build Time: 12:41:21</div><div class="line">[MCU2_0]     17.138886 s: ETHFW Commit SHA: 089d6723</div><div class="line">[MCU2_0]     17.138921 s: ETHFW: Init ... DONE !!!</div><div class="line">[MCU2_0]     17.139118 s: unibase-1.1.5-jacinto</div><div class="line">[MCU2_0]     17.139596 s: Starting lwIP, local interface IP is dhcp-enabled</div><div class="line">[MCU2_0]     17.145179 s: ETHFW: Host MAC address: 70:54:f4:f2:cc:8e</div><div class="line">[MCU2_0]     17.146387 s: ETHFW: ETHFW: Enable gPTP on MAC port 3 (tilld3)</div><div class="line">[MCU2_0]     17.146424 s: ETHFW: ETHFW: Enable gPTP on MAC port 5 (tilld5)</div><div class="line">[MCU2_0]     17.147229 s: [LWIPIF_LWIP] Enet LLD netif initialized successfully</div><div class="line">[MCU2_0]     17.147283 s: Added interface &#39;ti0&#39;, IP is 0.0.0.0</div><div class="line">[MCU2_0]     17.207305 s: ETHFW: EthFwTsn_gptpYangConfig:domain=0</div><div class="line">[MCU2_0]     17.225564 s: ETHFW: ETHFW: TimeSync PTP enabled</div><div class="line">[MCU2_0]     17.225591 s: ETHFW: Remove server Init ... !!!</div><div class="line">[MCU2_0]     17.225888 s: ETHFW: Virtual port configuration:</div><div class="line">[MCU2_0]     17.226416 s: ETHFW: CpswProxyServer: initialization completed (core: mcu2_0)</div><div class="line">[MCU2_0]     17.226452 s: ETHFW: Remove server Init ... DONE !!!</div><div class="line">[MCU2_0]     17.259211 s: INF:cbase:tilld3: has mac: 70:54:F4:F2:CC:8E</div><div class="line">[MCU2_0] INF:cbase:tilld5: has mac: 70:54:F4:F2:CC:8E</div><div class="line">[MCU2_0] INF:cbase:cb_lld_task_create: Uniconf Task stack_size=16384</div><div class="line">[MCU2_0] INF:cbase:cb_rawsock_open:combase-1.1.4-jacinto</div><div class="line">[MCU2_0] INF:cbase:cb_rawsock_open:dmaTxChId=-1 numRxChannel</div><div class="line">[MCU2_0]     17.259329 s: =0 dmaRxChId=-1 nTxPkts=0 nRxPkts=0 pktSize=0</div><div class="line">[MCU2_0] INF:cbase:cb_lld_task_create: uniconf_hwal_thread stack_size=16384</div><div class="line">[MCU2_0] INF:cbase:cb_lld_task_create: gPTP Task stack_size=16384</div><div class="line">[MCU2_0] INF:gptp:gptpman_run:max_domains=1, max_ports=2</div><div class="line">[MCU2_0] INF:cbase:cb_rawsock_open:comba</div><div class="line">[MCU2_0]     17.259432 s: e-1.1.4-jacinto</div><div class="line">[MCU2_0] INF:cbase:cb_rawsock_open:dmaTxChId=-1 numRxChannels=0 dmaRxChId=-1 nTxPkts=0 nRxPkts=0 pktSize=0</div><div class="line">[MCU2_0] INF:cbase:DmaOpen: TxChNum -1</div><div class="line">[MCU2_0] INF:cbase:DmaOpen: Rx startIdx 114 flowId 6</div><div class="line">[MCU2_0] INF:cbase:LLDEnetFilter:destmac:01:80:C2:00:00:0E, vlanId:0, </div><div class="line">[MCU2_0]     17.259525 s: thType:0x88f7</div><div class="line">[MCU2_0] INF:gptp:dev:tilld3 open success</div><div class="line">[MCU2_0] INF:gptp:dev:tilld5 open success</div><div class="line">[MCU2_0] INF:gptp:gptpnet_init:Open lldtsync OK!</div><div class="line">[MCU2_0] INF:gptp:IEEE1588-2019 performance monitoring disabled.</div><div class="line">[MCU2_0] INF:gptp:onenet_activate:tilld3 status=0, duplex=1, speed=0Mbps</div><div class="line">[MCU2_0] INF:gptp:</div><div class="line">[MCU2_0]     17.259610 s: nenet_activate:tilld5 status=0, duplex=1, speed=0Mbps</div><div class="line">[MCU2_0] INF:ubase:GPTP_MEDIUM_ALLOC: fragsize=16 fragused/fragnum=835/1426 (58</div><div class="line">[MCU2_0] INF:ubase:GPTP_SMALL_ALLOC: fragsize=4 fragused/fragnum=19/97 (19</div><div class="line">[MCU2_0] INF:ubase:SM_DATA_INST: fragsize=8 fragused/fragnum=20</div><div class="line">[MCU2_0]     17.259682 s: 2/3806 (52</div><div class="line">[MCU2_0] INF:gptp:gptpman_run:GPTPNET_INTERVAL_TIMEOUT_NSEC=125000000</div><div class="line"></div><div class="line">...</div><div class="line">15.010696 s: INF:cbase:cb_rawsock_open:dmaTxChId=-1 dmaRxChId=-1 nTxPkts=0 nRxPkts=0 pktSize=0</div><div class="line">[MCU2_0] INF:gptp:gptpnet_init:Open lldtsync OK!</div><div class="line">[MCU2_0] INF:gptp:000009-625285:domainIndex=0, GM changed old=00:00:00:00:00:00:00:00, new=70:FF:76:FF:FE:1D:92:C3</div><div class="line">[MCU2_0] INF:gptp:set_phase_offsetGM:domainNumber=0, New adjustment(New GM?)</div><div class="line">[MCU2_0] domain=0, offset=0nsec, hw-adjrate=0ppb</div><div class="line">[MCU2_0]         gmsync=true, last_setts64=0nsec</div></div><!-- fragment --><ul>
<li>You should also see the IP addresses assigned to the R5F and A72 cores as shown below. Note that 'br4' IP is the IP address of the R5F core. The addresses shown in your logs may be different.</li>
</ul>
<div class="fragment"><div class="line">[MCU2_0]  SNo.      IP Address          MAC Address   </div><div class="line">[MCU2_0]     20.599222 s: ------    -------------     -----------------</div><div class="line">[MCU2_0]     20.599257 s:   1       10.24.69.43     70:ff:76:1d:92:c2</div><div class="line">[MCU2_0]     20.601977 s: Function:CpswProxyServer_filterAddMacHandlerCb,HostId:0,Handle:a3ac1584,CoreKey:38acb7e6, MacAddress:1:0:5e:0:0:fc, vlanId:0, FlowIdx:173, FlowIdOffset:1</div><div class="line">[MCU2_0]     20.603914 s: Function:CpswProxyServer_filterAddMacHandlerCb,HostId:0,Handle:a3ac1584,CoreKey:38acb7e6, MacAddress:1:0:5e:0:0:fb, vlanId:0, FlowIdx:173, FlowIdOffset:1</div><div class="line">[MCU2_0]     22.010826 s: Added interface &#39;br4&#39;, IP is 10.24.68.137</div><div class="line">[MCU2_0]     25.010796 s: domain=0, offset=0nsec, hw-adjrate=0ppb</div><div class="line">[MCU2_0]         gmsync=true, last_setts64=0nsec</div></div><!-- fragment --><p>Please refer ETHFW demo userguide for more details.</p>
<h2><a class="anchor" id="autotoc_md191"></a>
ping test</h2>
<p>Once the EVM is booted along with Linux on A72, the virtual net driver module should be loaded and the eth1 network device corresponding to CPSW9G should be added.</p>
<ol type="1">
<li>Verify this by running ifconfig -a on Linux terminal console of the EVM.</li>
<li>Activate network interface on A72 core as follows: <div class="fragment"><div class="line">sudo ifconfig eth1 up</div></div><!-- fragment --></li>
<li>At this point, data transfer with other devices connected to the network should be possible. Ping the two PCs connected to the switch: <div class="fragment"><div class="line">ping 10.24.69.&lt;pc1&gt;</div><div class="line">ping 10.24.69.&lt;pc2&gt;</div></div><!-- fragment --></li>
<li>Similarly, ping the A72 core from either PC connected to the switch: <div class="fragment"><div class="line">ping 10.24.69.&lt;a72&gt;</div></div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md192"></a>
TCP iperf test</h2>
<p>The CPSW switch is capable of steering network traffic without CPU intervention by classifying it based on its characteristics. This can be demonstrated by running iperf server on Linux running on the A72 core and iperf client on any of the external devices, PC 1 or PC 2.</p>
<ol type="1">
<li>Start iperf server on Linux running on A72. <div class="fragment"><div class="line">iperf -s</div></div><!-- fragment --></li>
<li>Run iperf client on the selected PC. Set test duration with -t option as needed. <div class="fragment"><div class="line">iperf -c 10.24.69.&lt;a72&gt; -t 20 -i 1</div></div><!-- fragment --></li>
</ol>
<p>Refer ETHFW userguide documentation for more details</p>
<h2><a class="anchor" id="autotoc_md193"></a>
gPTP logs for master and slave</h2>
<p>After installing ptp4l on PC2, create a ptp config file (ptp_config.cfg) for setting different ptp params while testing gPTP. The contents of the file can be as follows:</p>
<div class="fragment"><div class="line">[global]</div><div class="line">gmCapable       1</div><div class="line">priority1       238</div><div class="line">priority2       248</div><div class="line">logAnnounceInterval 0</div><div class="line">logSyncInterval     -3</div><div class="line">syncReceiptTimeout  3</div><div class="line">neighborPropDelayThresh 800</div><div class="line">min_neighbor_prop_delay -20000000</div><div class="line">assume_two_step     1</div><div class="line">path_trace_enabled  1</div><div class="line">follow_up_info      1</div><div class="line">transportSpecific   0x1</div><div class="line">ptp_dst_mac     01:80:C2:00:00:0E</div><div class="line">network_transport   L2</div><div class="line">delay_mechanism     P2P</div></div><!-- fragment --><p>By changing priority1 to 220 or 255 you can force your PC2 to run either as master or slave. Run the following command on PC2 for starting ptp4l: </p><div class="fragment"><div class="line">sudo ptp4l -i &lt;net-interface&gt; -m -l 6 -q -f ~/ptp_config.cfg</div></div><!-- fragment --><p>If your EVM is running as master, the logs are as follows:</p>
<div class="fragment"><div class="line">[MCU2_0]     45.213639 s: domain=0, offset=0nsec, hw-adjrate=0ppb</div><div class="line">[MCU2_0]         gmsync=true, last_setts64=0nsec</div><div class="line">[MCU2_0]     55.213637 s: domain=0, offset=0nsec, hw-adjrate=0ppb</div><div class="line">[MCU2_0]         gmsync=true, last_setts64=0nsec</div><div class="line">[MCU2_0]     65.213641 s: domain=0, offset=0nsec, hw-adjrate=0ppb</div><div class="line">[MCU2_0]         gmsync=true, last_setts64=0nsec</div><div class="line">[MCU2_0]     75.213786 s: domain=0, offset=0nsec, hw-adjrate=0ppb</div><div class="line">[MCU2_0]         gmsync=true, last_setts64=0nsec</div></div><!-- fragment --><p>If your EVM is running as slave, your logs are as follows:</p>
<div class="fragment"><div class="line">[MCU2_0]     39.115644 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -4571ppb, GMdiff=239nsec</div><div class="line">[MCU2_0]     40.115645 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -4471ppb, GMdiff=620nsec</div><div class="line">[MCU2_0]     41.115647 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -4333ppb, GMdiff=1001nsec</div><div class="line">[MCU2_0]     42.115646 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -4159ppb, GMdiff=1372nsec</div><div class="line">[MCU2_0]     43.115642 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -3948ppb, GMdiff=1746nsec</div><div class="line">[MCU2_0]     44.115646 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -3737ppb, GMdiff=1930nsec</div><div class="line">[MCU2_0]     45.115642 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -3489ppb, GMdiff=2210nsec</div><div class="line">[MCU2_0] domain=0, offset=0nsec, hw-adjrate=-3489ppb</div><div class="line">[MCU2_0]         gmsync=true, last_setts64=0nsec</div><div class="line">[MCU2_0]     46.115644 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -3252ppb, GMdiff=2296nsec</div><div class="line">[MCU2_0]     47.115647 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -3023ppb, GMdiff=2293nsec</div><div class="line">[MCU2_0]     48.115642 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -2797ppb, GMdiff=2275nsec</div><div class="line">[MCU2_0]     49.115648 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -2623ppb, GMdiff=2008nsec</div><div class="line">[MCU2_0]     50.115641 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -2455ppb, GMdiff=1846nsec</div><div class="line">[MCU2_0]     51.115647 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -2319ppb, GMdiff=1601nsec</div><div class="line">[MCU2_0]     52.115643 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -2210ppb, GMdiff=1348nsec</div><div class="line">[MCU2_0]     53.115645 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -2158ppb, GMdiff=930nsec</div><div class="line">[MCU2_0]     54.115638 s: IFV:gptp:domainNumber=0, clock_master_sync_receive:the master clock rate to -2124ppb, GMdiff=630nsec</div><div class="line">[MCU2_0]     55.115649 s: domain=0, offset=0nsec, hw-adjrate=-2124ppb</div><div class="line">[MCU2_0]         gmsync=true, last_setts64=0nsec</div></div><!-- fragment --><p>gPTP in ETHFW supports different log levels from information to debug, to limit the amount of ETHFW traces. However, user may want to see accuracy of the synchronization achieved on the <em>slave</em> device. Thi requires a change in logging level in ETHFW library, from from <code>gptp:45</code> to <code>gptp:55</code> in <code>ethfw_tsn.c</code> file as shown in the snippet:</p>
<div class="fragment"><div class="line">static void EthFw_tsnInit(void)</div><div class="line">{</div><div class="line">    unibase_init_para_t params;</div><div class="line">    ...</div><div class="line">    /*refer to &#39;ub_logging.h for logging levels*/</div><div class="line">    ubb_default_initpara(&amp;params);</div><div class="line">    params.ub_log_initstr  = &quot;4,ubase:45,cbase:45,uconf:45,gptp:45&quot;;</div><div class="line">    ...</div><div class="line">    unibase_init(&amp;params);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>Please refer ETHFW demo/userguide for more details.</p>
<h2><a class="anchor" id="autotoc_md194"></a>
Enhanced Schedule Traffic(EST) demo support</h2>
<p>This demo application demonstrates how to configure the 802.1 Qbv (EST) through the TSN yang interface.</p>
<blockquote class="doxtable">
<p><b>Note:</b> This demo is supported on MAC port 3 only for all the boards (J721E, J784S4), whose interface name is <code>tilld3</code> </p>
</blockquote>
<ul>
<li>This application can only run as either listener or talker, where talker will be sending out AVTP packets based on the configured EST schedule and listener recieves those packets and validates if the packect has been recieved in the expected time interval. Out-of-box this demo supports 2 streams of traffic on talker side with traffic priorities 0 and 2 mapped to HW queue 0 and 2 respectively.</li>
</ul>
<h3><a class="anchor" id="autotoc_md195"></a>
Configuration parameters</h3>
<p>This demo uses <code>EthFwEstDemoTestParam</code> in <code>ethfw_estdemo.c</code> file structure which is populated by user as a static configuration.This structure contains all the params required for setting up EST, once the user fills the required configuration needed, this gets passed to the TSN stack for enabling and scheduling EST. In the demo application provided out-of-box, following are the config params for EST:</p>
<div class="fragment"><div class="line">static EthFwEstDemoTestParam gEthFwEstDemoTestLists[] =</div><div class="line">   {</div><div class="line">      {</div><div class="line">         .list =</div><div class="line">         {</div><div class="line">               .baseTime    = 0ULL,</div><div class="line">               .cycleTime   = 4*MIN_INTERVAL_NS,</div><div class="line">               .gateCmdList =</div><div class="line">               {</div><div class="line">                  { .gateStateMask = ENET_TAS_GATE_MASK(1, 0, 0, 0, 0, 0, 0, 1),</div><div class="line">                     .timeInterval =  MIN_INTERVAL_NS</div><div class="line">                  },</div><div class="line">                  { .gateStateMask = ENET_TAS_GATE_MASK(1, 0, 0, 0, 0, 1, 0, 0),</div><div class="line">                     .timeInterval =  MIN_INTERVAL_NS</div><div class="line">                  },</div><div class="line">                  { .gateStateMask = ENET_TAS_GATE_MASK(1, 0, 0, 0, 0, 0, 0, 1),</div><div class="line">                     .timeInterval =  MIN_INTERVAL_NS</div><div class="line">                  },</div><div class="line">                  { .gateStateMask = ENET_TAS_GATE_MASK(1, 0, 0, 0, 0, 1, 0, 0),</div><div class="line">                     .timeInterval =  MIN_INTERVAL_NS</div><div class="line">                  },</div><div class="line">               },</div><div class="line">               .listLength = 4U,</div><div class="line">         },</div><div class="line">         .stParam =</div><div class="line">         {</div><div class="line">               .streamParams =</div><div class="line">               {</div><div class="line">                  /* test appliction sends packet with interval 200us */</div><div class="line">                  {.bitRateKbps = CALC_BITRATE_KBPS(AVTP_PKT_PAYLOAD_LEN, 200),</div><div class="line">                  .payloadLen = AVTP_PKT_PAYLOAD_LEN,</div><div class="line">                  .tc = 0U,</div><div class="line">                  .priority = 0U,</div><div class="line">                  },</div><div class="line">                  /* test appliction sends packet with interval 200us */</div><div class="line">                  {.bitRateKbps = CALC_BITRATE_KBPS(AVTP_PKT_PAYLOAD_LEN, 200),</div><div class="line">                  .payloadLen = AVTP_PKT_PAYLOAD_LEN,</div><div class="line">                  .tc = 2U,</div><div class="line">                  .priority = 2U,</div><div class="line">                  },</div><div class="line">               },</div><div class="line">               .nStreams = 2U,</div><div class="line">         }</div><div class="line">      },</div><div class="line">   };</div></div><!-- fragment --><p>The above structure holds the gate command list, interval time, cycle time and base time which are specific to EST configuration. Base time will however be calculated later as future time in multiples of cycle time. Additionally, one can set up the stream params (params per priority channel) with the bitrate (in kbps) where each packet's size is 1200 Bytes. Here 200us denotes the time interval between two consecutive priority packets. User can add/remove priorities from gameCmdList and streamParams based on their requirement. But the seventh priority channel should always be open for gPTP traffic, which is required for keeping listener and talker in sync.</p>
<h3><a class="anchor" id="autotoc_md196"></a>
Build EST Demo</h3>
<p>Following build flags are defined in <code>&lt;sdk_builder/vision_apps_build_flags.mak&gt;</code></p><ul>
<li><code>ETHFW_EST_DEMO_SUPPORT</code> : To enabled EST demo App</li>
</ul>
<p>Following build flags are defined in <code>&lt;ethfw&gt;/ethfw_build_flags.mak</code> file as:</p><ul>
<li><code>ETHFW_EST_DEMO_SUPPORT</code> : To enabled EST demo App</li>
<li><code>ETHFW_EST_DEMO_TALKER</code> : To run EST demo app in talker mode</li>
<li><code>ETHFW_EST_DEMO_LISTENER</code> : To run demo app in listener mode</li>
</ul>
<p>One cannot build EST demo app with both listener/talker enabled or disabled. It is necessary to state in which mode you want to run EST.</p>
<p>In a nutshell to run EST demo app, you need to have the following build flags in <code>ethfw_build_flags.mak</code>:</p><ul>
<li><code>ETHFW_EST_DEMO_SUPPORT</code>: yes</li>
<li><code>ETHFW_EST_DEMO_TALKER</code> OR <code>ETHFW_EST_DEMO_LISTENER</code> : yes</li>
<li><code>ETHFW_GPTP_SUPPORT</code>: yes</li>
</ul>
<p>And following build flags in <code>vision_apps_build_flags.mak</code>:</p><ul>
<li><code>ETHFW_EST_DEMO_SUPPORT</code>: yes</li>
<li><code>ETHFW_GPTP_SUPPORT</code>: yes</li>
</ul>
<blockquote class="doxtable">
<p><b>Note</b> : This demo is supported only is gPTP is enabled in EthFw, so make sure ETHFW_GPTP_SUPPORT is <code>yes</code> </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md197"></a>
Run EST Demo App</h3>
<ul>
<li>We need any two EVMs for running this demo (J721E-EVM or J784S4-EVM).</li>
<li>Build one EVM as talker and one EVM as listener and connect both of them via MAC port 3.</li>
<li>Once both the boards have been synchronized and in stable state, the talker will start sending packets.</li>
<li>Once both the boards have been synchronized, listener is ready to recieve packets.</li>
<li>Listener starts printing the stats everytime it recieves 20000 packets of priority 0 or 2.</li>
</ul>
<h3><a class="anchor" id="autotoc_md198"></a>
EST Logs</h3>
<p>Talker: </p><div class="fragment"><div class="line">Waiting for PTP clock to be synchronized!</div><div class="line">The following AdminList param will be configured for EST:</div><div class="line">GateMask[7..0]=oCCCCCCo (0x81), start=0 ns, end=61999 ns, dur=62000 ns</div><div class="line">GateMask[7..0]=oCCCCoCC (0x84), start=62000 ns, end=123999 ns, dur=62000 ns</div><div class="line">GateMask[7..0]=oCCCCCCo (0x81), start=124000 ns, end=185999 ns, dur=62000 ns</div><div class="line">GateMask[7..0]=oCCCCoCC (0x84), start=186000 ns, end=247999 ns, dur=62000 ns</div><div class="line">Base time=24800000000ns,Cycle time=248000ns</div><div class="line">Set admin control list succesfully</div><div class="line">INF:cbase:TAS state is set to 2</div><div class="line">INF:cbase:TAS operational list status updated:</div><div class="line">INF:cbase:TAS state is set to 1</div><div class="line">INF:cbase:Successfully configure TAS </div><div class="line">Talker: starting stream 0 with, payloadLen: 1200, bitrate: 24360 kbps, priority: 0</div><div class="line">Talker: starting stream 1 with, payloadLen: 1200, bitrate: 24360 kbps, priority: 2</div><div class="line">Talker[0], payloadLen: 1200 bytes, bitRate: 24360 kbps</div><div class="line">Talker[1], payloadLen: 1200 bytes, bitRate: 24360 kbps</div><div class="line">Start the talker successfully!</div><div class="line">INF:cbase:cb_lld_task_create: EthFw EST demo Talker stack_size=16384</div><div class="line">INF:cbase:task_fxn:task (EthFw EST demo Task) terminated.</div></div><!-- fragment --><p>Listener: </p><div class="fragment"><div class="line">TimeSlots of PacketPriority: 0:   [0, 62000]ns,  [124000, 186000]ns,</div><div class="line">TimeSlots of PacketPriority: 2:   [62000, 124000]ns,  [186000, 248000]ns,</div><div class="line">The following AdminList param will be configured for EST:</div><div class="line">GateMask[7..0]=oCCCCCCo (0x81), start=0 ns, end=61999 ns, dur=62000 ns</div><div class="line">GateMask[7..0]=oCCCCoCC (0x84), start=62000 ns, end=123999 ns, dur=62000 ns</div><div class="line">GateMask[7..0]=oCCCCCCo (0x81), start=124000 ns, end=185999 ns, dur=62000 ns</div><div class="line">GateMask[7..0]=oCCCCoCC (0x84), start=186000 ns, end=247999 ns, dur=62000 ns</div><div class="line">Base time=24800000000ns,Cycle time=248000ns</div><div class="line">Set admin control list succesfully</div><div class="line">Create listener task succesfully!</div><div class="line">INF:cbase:TAS state is set to 2</div><div class="line">INF:cbase:TAS operational list status updated:</div><div class="line">INF:cbase:TAS state is set to 1</div><div class="line">INF:cbase:Successfully configure TAS </div><div class="line">INF:cbase:cb_lld_task_create: EthFw EST demo Listener stack_size=16384</div><div class="line">INF:cbase:LLDEnetFilter:destmc:91:E0:F0:00:FE:00, vlanId:110, ethType:0x22f0</div><div class="line">INF:cbase:task_fxn:task (EthFw EST demo Task) terminated.</div><div class="line">INF:gptp:domainIndex=0, clock_master_sync_receive:stable rate, 15687msec from unstable</div><div class="line">PacketPriority[0], frameLength: 1218B, receivedBitrate: 0Kbps</div><div class="line">PacketPriority[2], frameLength: 1218B, receivedBitrate: 0Kbps</div><div class="line">PacketPriority: 0, nGoodPackets: 20000, nBadPackets: 150, percentage of bad packets: 0%</div><div class="line">PacketPriority: 2, nGoodPackets: 19532, nBadPackets: 146, percentage of bad packets: 0%</div><div class="line">PacketPriority: 0, nGoodPackets: 20483, nBadPackets: 153, percentage of bad packets: 0%</div><div class="line">PacketPriority: 2, nGoodPackets: 20000, nBadPackets: 153, percentage of bad packets: 0%</div><div class="line">PacketPriority: 0, nGoodPackets: 40000, nBadPackets: 301, percentage of bad packets: 0%</div><div class="line">PacketPriority: 2, nGoodPackets: 39013, nBadPackets: 291, percentage of bad packets: 0%</div><div class="line">PacketPriority: 0, nGoodPackets: 41009, nBadPackets: 310, percentage of bad packets: 0%</div><div class="line">PacketPriority: 2, nGoodPackets: 40000, nBadPackets: 301, percentage of bad packets: 0%</div><div class="line">PacketPriority[0], frameLength: 1218B, receivedBitrate: 20498Kbps</div><div class="line">PacketPriority[2], frameLength: 1218B, receivedBitrate: 19990Kbps</div></div><!-- fragment --><p>Both the listener and talker logs print the EST schedule which has been configured on each side along with admin base time and cycle time. Talker prints the streams which are sending the traffic long with the size and bit rate of the packets which can be cross-checked on the listener side later. Whereas on the listener side same info as on talker side is printed along with the number of good packets, bad packets and the percentage of bad packets per stream, where good packets are the packets which have been received in the expected time slot and bad ones being the one received out of time slot. High bad packet number will be observed if the listener and talker are not synchronized properly, suggested GMdiff &lt; 1000nsecs. The bitrate of the received traffic stream is printed roughly around every 20 secs.</p>
<p>Please refer ETHFW demo guide for more details</p>
<h2><a class="anchor" id="autotoc_md199"></a>
For QNX after running the vision_apps_init.sh script bring up the CPSW ethernet virtual driver as below,</h2>
<div class="fragment"><div class="line">slog2info -c</div><div class="line">slog2info -w &amp;</div><div class="line">io-pkt-v6-hc -d cpsw9g verbose=0x0</div><div class="line">dhclient -nw an0</div><div class="line">ifconfig -v</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md200"></a>
Known Issues</h1>
<ul>
<li>The GESI card uses the same connector pins as infotainment card so only one of them can be connected</li>
<li>With EthFw enabled by default, if infotainment board is connected it results in HDMI display corruption. eDP to HDMI adaptors also cannot be used with EthFw enabled. To workaround this issue disable EthFw if required or switch display to eDP.</li>
</ul>
<h1><a class="anchor" id="ETHFW_HOWTO_DISABLE"></a>
How to disable ETHFW</h1>
<ul>
<li>In file vision_apps_build_flags.mak, set BUILD_ENABLE_ETHFW?=no</li>
<li>Run "make vision_apps_scrub" prior to re-building</li>
<li>Note: Ethernet Firmware must be disabled in order to use the HDMI display</li>
</ul>
<h2><a class="anchor" id="autotoc_md201"></a>
How to disable gPTP in ETHFW</h2>
<ul>
<li>In file vision_apps_build_flags.mak, set ETHFW_GPTP_SUPPORT?=no</li>
<li>Run "make vision_apps_scrub" prior to re-building</li>
<li>Note: You can't run gPTP if ETHFW is disabled </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
